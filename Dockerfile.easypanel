# Ultra-Minimal Single Container for EasyPanel with Supabase
# Uses supervisord to run multiple services in one container

FROM node:22-alpine AS base

# Install minimal build dependencies (no PostgreSQL client needed)
RUN apk add --no-cache \
    git \
    sqlite \
    python3 \
    make \
    g++ \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# Copy package files for dependency installation
COPY package*.json ./

# Install dependencies with aggressive optimization
RUN npm ci --only=production --ignore-scripts && \
    npm cache clean --force && \
    # Remove unnecessary files for smaller image
    find node_modules -name "*.md" -delete && \
    find node_modules -name "*.txt" -delete && \
    find node_modules -name "test" -type d -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -name "*.map" -delete && \
    find node_modules -name "*.ts" -delete

# Ultra-minimal production stage with supervisord
FROM node:22-alpine AS production

# Install only essential runtime dependencies (no PostgreSQL client)
RUN apk add --no-cache \
    supervisor \
    curl \
    bash \
    sqlite \
    tzdata \
    dumb-init \
    && rm -rf /var/cache/apk/* /tmp/*

WORKDIR /app

# Create app user for security
RUN addgroup -g 1001 -S nodejs && \
    adduser -S botuser -u 1001

# Copy optimized dependencies
COPY --from=base /app/node_modules ./node_modules

# Copy application code (selective copying)
COPY src/ ./src/
COPY scripts/ ./scripts/
COPY package.json ./
COPY .env.example ./

# Create directories with proper permissions
RUN mkdir -p data data/sessions logs backups tmp /var/log/supervisor && \
    chown -R botuser:nodejs data data/sessions logs backups tmp && \
    chmod 755 data data/sessions logs backups tmp

# Make scripts executable
RUN find scripts -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true

# Create .env from environment variables
RUN node scripts/create-env.js || echo "Warning: Could not create .env file"

# Final cleanup for smaller image
RUN rm -rf /tmp/* /var/cache/apk/* && \
    find . -name "*.log" -delete 2>/dev/null || true

# Create supervisord configuration
COPY <<EOF /etc/supervisord.conf
[supervisord]
nodaemon=true
user=root
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
silent=false
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Main WhatsApp Bot Application
[program:whatsapp-bot]
command=node src/index.js
directory=/app
user=botuser
autostart=true
autorestart=true
autorestart_delay=10
startretries=5
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=NODE_ENV=production,NODE_OPTIONS="--max-old-space-size=384 --gc-interval=100"

# Anti-spam Monitor (lightweight)
[program:antispam-monitor]
command=bash -c "sleep 60 && while true; do echo '[ANTISPAM] Running check at \$(date)'; node scripts/anti-spam-monitor.js stats || echo '[ANTISPAM] Monitor check failed'; sleep 300; done"
directory=/app
user=botuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# Session Cleanup Service
[program:session-cleanup]
command=bash -c "sleep 120 && while true; do echo '[CLEANUP] Running cleanup at \$(date)'; node scripts/cleanup-sessions.js cleanup || echo '[CLEANUP] Cleanup failed'; sleep 600; done"
directory=/app
user=botuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# Health Monitor (minimal for EasyPanel)
[program:health-monitor]
command=bash -c "sleep 90 && while true; do if curl -sf http://localhost:3000/health >/dev/null; then echo '[HEALTH] OK at \$(date)'; else echo '[HEALTH] Failed at \$(date)'; fi; sleep 300; done"
directory=/app
user=botuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# Log Rotator (minimal cleanup for EasyPanel)
[program:log-rotator]
command=bash -c "while true; do echo '[LOGROTATE] Running cleanup at \$(date)'; find /app/logs -name '*.log' -size +30M -delete 2>/dev/null || true; find /var/log/supervisor -name '*.log' -mtime +3 -delete 2>/dev/null || true; sleep 7200; done"
directory=/app
user=botuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
EOF

# Create minimal health check script for EasyPanel
COPY <<EOF /usr/local/bin/healthcheck.sh
#!/bin/bash
set -e

# Check if supervisord is running
if ! pgrep -f supervisord >/dev/null; then
    echo "Supervisord not running"
    exit 1
fi

# Check if main bot process is running
if ! pgrep -f "node src/index.js" >/dev/null; then
    echo "Main bot process not running"
    exit 1
fi

# Check if bot HTTP endpoint is responding
if ! curl -f http://localhost:3000/health >/dev/null 2>&1; then
    echo "Bot health endpoint not responding"
    exit 1
fi

echo "EasyPanel health check passed"
exit 0
EOF

RUN chmod +x /usr/local/bin/healthcheck.sh

# Create startup script for EasyPanel
COPY <<EOF /usr/local/bin/start-easypanel.sh
#!/bin/bash
set -e

echo "ðŸš€ Starting WhatsApp Bot for EasyPanel..."
echo "ðŸ“… Started at: \$(date)"
echo "ðŸ§ Base: Alpine Linux with supervisord"
echo "ðŸ‘¤ Running as: Multi-user (supervisord + botuser)"

# Environment check
echo "ðŸ”§ Checking environment..."
if [ ! -f ".env" ]; then
    echo "âš ï¸ No .env file found, creating from environment variables..."
    node scripts/create-env.js || echo "Warning: Could not create .env"
fi

# Note: Using Supabase - no local database test needed
echo "ðŸ—„ï¸ Database: Supabase (external)"

# Check disk space
echo "ðŸ’¾ Checking disk space..."
df -h | head -2 || true

# Start supervisord which will manage all services
echo "ðŸŽ¯ Starting supervisord with all services..."
echo "Services that will be started:"
echo "  - WhatsApp Bot (main application)"
echo "  - Anti-spam Monitor (every 5 minutes)"  
echo "  - Session Cleanup (every 10 minutes)"
echo "  - Health Monitor (every 5 minutes)"
echo "  - Log Rotator (every 2 hours)"
echo ""
echo "ðŸ“‹ All logs will be displayed in Docker logs"

exec supervisord -c /etc/supervisord.conf
EOF

RUN chmod +x /usr/local/bin/start-easypanel.sh

# Create supervisord status check script
COPY <<EOF /usr/local/bin/supervisor-status.sh
#!/bin/bash
echo "ðŸ“Š Supervisor Status:"
supervisorctl status

echo ""
echo "ðŸ” Process Status:"
ps aux | grep -E "(supervisord|node|cleanup|monitor)" | grep -v grep

echo ""
echo "ðŸ“ Recent Application Logs:"
echo "Check Docker logs for all service output:"
echo "  docker logs whatsapp-bot-easypanel"
echo ""
echo "Or use NPM command:"
echo "  npm run easypanel:logs"
EOF

RUN chmod +x /usr/local/bin/supervisor-status.sh

# Set proper ownership
RUN chown -R botuser:nodejs /app

# Health check configuration for EasyPanel
HEALTHCHECK --interval=60s --timeout=15s --start-period=120s --retries=3 \
    CMD ["/usr/local/bin/healthcheck.sh"]

# Set environment variables optimized for single container
ENV NODE_ENV=production \
    LOG_LEVEL=info \
    ANTI_SPAM_EMERGENCY_BRAKE=true \
    ENABLE_AI_FEATURES=true \
    PORT=3000 \
    # Alpine-specific memory optimizations
    NODE_OPTIONS="--max-old-space-size=384 --gc-interval=100" \
    # Reduce npm memory usage
    NPM_CONFIG_FUND=false \
    NPM_CONFIG_AUDIT=false \
    # Timezone
    TZ=Asia/Jakarta

# Expose port
EXPOSE 3000

# Use dumb-init for proper signal handling
ENTRYPOINT ["dumb-init", "--"]

# Start with EasyPanel-optimized script
CMD ["/usr/local/bin/start-easypanel.sh"]

# Labels for EasyPanel identification
LABEL maintainer="WhatsApp Financial Bot for EasyPanel" \
      version="1.0.0" \
      description="Single container with supervisord for multiple services" \
      deployment="easypanel" \
      base="alpine" \
      services="bot,monitor,cleanup,health,logs"